<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"  lang="en-gb">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<title>Division in Verilog | Project F</title>

<meta property='og:title' content='Division in Verilog - Project F'>
<meta property='og:description' content='Division is a fundamental arithmetic operation, but unlike addition, subtraction, and multiplication, you need to implement yourself. In this FPGA recipe we&rsquo;re going to look at a simple division method that takes one cycle per bit (32 cycles for 32-bit numbers). There are other methods that generate the result in fewer cycles, but they are more complex to implement and to use.
This is a DRAFT: expect updates and fixes.'>
<meta property='og:url' content='https://projectf.io/posts/division-in-verilog/'>
<meta property='og:site_name' content='Project F'>
<meta property='og:type' content='article'><meta property='og:image' content='https://projectf.io/img/posts/fixed-point-numbers-in-verilog/social-card.png'><meta property='article:published_time' content='2020-07-01T00:00:00Z'/><meta property='article:modified_time' content='2020-07-01T00:00:00Z'/><meta name='twitter:card' content='summary_large_image'><meta name='twitter:site' content='@WillFlux'><meta name='twitter:creator' content='@WillFlux'>


<link href="https://projectf.io/index.xml" rel="alternate" type="application/rss+xml" title="Project F" />

<link rel="stylesheet" href="/css/style.css"/><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
<link rel="canonical" href="https://projectf.io/posts/division-in-verilog/">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">
<meta name="referrer" content="no-referrer, same-origin">
</head>
<body>
<section class="section">
  <div class="container">
    <nav id="nav-main" class="nav">
      <div id="nav-name" class="nav-left">
        <a id="nav-anchor" class="nav-item" href="https://projectf.io">
          <h1 id="nav-heading" class="title is-4">Project F</h1>
        </a>
      </div>
      <div class="nav-right">
        <nav id="nav-items" class="nav-item level is-mobile"><a class="level-item" aria-label="github" href='https://github.com/projf'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="twitter" href='https://twitter.com/WillFlux'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="youtube" href='https://youtube.com/channel/UCaT0lvfWo1GStbp0neg8weg'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M22.54 6.42a2.78 2.78 0 0 0-1.94-2C18.88 4 12 4 12 4s-6.88 0-8.6.46a2.78 2.78 0 0 0-1.94 2A29 29 0 0 0 1 11.75a29 29 0 0 0 .46 5.33A2.78 2.78 0 0 0 3.4 19c1.72.46 8.6.46 8.6.46s6.88 0 8.6-.46a2.78 2.78 0 0 0 1.94-2 29 29 0 0 0 .46-5.25 29 29 0 0 0-.46-5.33z"/>
    <polygon points="9.75 15.02 15.5 11.75 9.75 8.48 9.75 15.02"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="rss" href='/index.xml'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle>
    
  </svg></i>
            </span>
          </a></nav>
      </div>
    </nav>

    <nav class="nav">
      
      <div class="nav-left"><a class="nav-item" href="/tags/cookbook">
          <h2 class="title is-5">Cookbook</h2>
        </a><a class="nav-item" href="/tags/explore">
          <h2 class="title is-5">Explore</h2>
        </a><a class="nav-item" href="/tags/tools">
          <h2 class="title is-5">Tools</h2>
        </a></div>
      

      
    </nav>

  </div>
  <script src="/js/navicon-shift.js"></script>
</section>
<section class="section">
  <div class="container">
    <div class="subtitle tags is-6 is-pulled-right">
      
      
<a class="subtitle is-6" href="/tags/cookbook/">#cookbook</a>




      
    </div>
    <h2 class="subtitle is-6">July 1, 2020</h2>
    <h1 class="title">Division in Verilog</h1>
    
    <div class="content">
      <p>Division is a fundamental arithmetic operation, but unlike addition, subtraction, and multiplication, you need to implement yourself. In this FPGA recipe we&rsquo;re going to look at a simple division method that takes one cycle per bit (32 cycles for 32-bit numbers). There are other methods that generate the result in fewer cycles, but they are more complex to implement and to use.</p>
<p><strong>This is a DRAFT: expect updates and fixes.</strong><br>
<em>Feedback to <a href="https://twitter.com/WillFlux">@WillFlux</a> is most welcome.</em></p>
<h2 id="integer-division">Integer Division</h2>
<p>Before we get to the design we need to be familiar with some terminology.</p>
<p>When you divide <strong>dividend</strong> <code>X</code> by <strong>divisor</strong> <code>Y</code> you get <strong>quotient</strong> <code>Q</code> and <strong>remainder</strong> <code>R</code>:</p>
<p>Consider a trivial example: you have seven slices of apple pie to divide equally amongst three people. Each person gets two slices of pie, and there is one slice left over, or less tastily:</p>
<p>Given <code>X=7</code> and <code>Y=3</code> then <code>Q=2</code> and <code>R=1</code> because <code>7 = 3*2 + 1</code></p>
<p>Or more generally: <code>X = Y*Q + R</code>.</p>
<p>For calculation in Verilog, we&rsquo;re going to use a variant of <strong>restoring division</strong>, which works in much the same way as the familiar <a href="https://en.wikipedia.org/wiki/Long_division">long division</a> for decimal numbers.</p>
<p><em><strong>I&rsquo;m planning on adding a nice flow chart here to show how the algorithm works.</strong></em></p>
<blockquote>
<p><strong>Quick Aside: Divide is typically much slower than multiplication</strong><br>
Even high-end CPUs take their time with division. Intel Skylake has a latency of 42-95 cycles for signed 64-bit integer division, but only 3 cycles for multiplication. Source: <a href="https://www.agner.org/optimize/instruction_tables.pdf">agner.org</a>.</p>
</blockquote>
<h2 id="verilog-design">Verilog Design</h2>
<p>To use the module, set <code>WIDTH</code> to the correct number of bits and the inputs <code>x</code> and <code>y</code> to dividend and divisor respectively. To begin the calculation set <code>start</code> high for one clock. The <code>done</code> signal indicates when the calculation is complete, then you can read the result out of <code>q</code> and <code>r</code>. If you divide by zero, then <code>q</code> and <code>r</code> will be zero and the <code>dbz</code> flag signal will be high.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-verilog" data-lang="verilog"><span style="color:#75715e">// Project F: Division
</span><span style="color:#75715e">// (C)2020 Will Green, Open source hardware released under the MIT License
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">module</span> div #(<span style="color:#66d9ef">parameter</span> WIDTH<span style="color:#f92672">=</span><span style="color:#ae81ff">32</span>)
    (
    <span style="color:#66d9ef">input</span> <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> clk,
    <span style="color:#66d9ef">input</span> <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> start,          <span style="color:#75715e">// start signal
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">input</span> <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> [WIDTH<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] x,  <span style="color:#75715e">// dividend
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">input</span> <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> [WIDTH<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] y,  <span style="color:#75715e">// divisor
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>     <span style="color:#66d9ef">logic</span> [WIDTH<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] q,  <span style="color:#75715e">// quotient
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>     <span style="color:#66d9ef">logic</span> [WIDTH<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] r,  <span style="color:#75715e">// remainder
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>     <span style="color:#66d9ef">logic</span> done,           <span style="color:#75715e">// done signal
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>     <span style="color:#66d9ef">logic</span> dbz             <span style="color:#75715e">// divide by zero flag
</span><span style="color:#75715e"></span>    );

    <span style="color:#66d9ef">logic</span> [WIDTH<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] y1;            <span style="color:#75715e">// copy of divisor
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [WIDTH<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] q1, q1_next;   <span style="color:#75715e">// intermediate quotient
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [WIDTH<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] r1, r1_next;   <span style="color:#75715e">// intermediate remainder
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [$clog2(WIDTH<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>)<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] i;   <span style="color:#75715e">// dividend bit counter
</span><span style="color:#75715e"></span>
    <span style="color:#66d9ef">always_comb</span> <span style="color:#66d9ef">begin</span>
        <span style="color:#66d9ef">if</span> (r1 <span style="color:#f92672">&gt;=</span> y1) <span style="color:#66d9ef">begin</span>
            r1_next <span style="color:#f92672">=</span> r1 <span style="color:#f92672">-</span> y1;
            {r1_next, q1_next} <span style="color:#f92672">=</span> {r1_next[WIDTH<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>], q1, <span style="color:#ae81ff">1</span><span style="color:#ae81ff">&#39;b1</span>};
        <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">begin</span>
            {r1_next, q1_next} <span style="color:#f92672">=</span> {r1, q1} <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">1</span>;
        <span style="color:#66d9ef">end</span>
    <span style="color:#66d9ef">end</span>

    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk) <span style="color:#66d9ef">begin</span>
        <span style="color:#66d9ef">if</span> (start) <span style="color:#66d9ef">begin</span>
            <span style="color:#66d9ef">if</span> (y <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) <span style="color:#66d9ef">begin</span>  <span style="color:#75715e">// catch divide by zero
</span><span style="color:#75715e"></span>                dbz <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1</span>;
                done <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1</span>;
                q <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
                r <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
            <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">begin</span>  <span style="color:#75715e">// initialize values
</span><span style="color:#75715e"></span>                dbz <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
                done <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
                i <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
                y1 <span style="color:#f92672">&lt;=</span> y;
                {r1, q1} <span style="color:#f92672">&lt;=</span> {{WIDTH<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>{<span style="color:#ae81ff">1</span><span style="color:#ae81ff">&#39;b0</span>}}, x, <span style="color:#ae81ff">1</span><span style="color:#ae81ff">&#39;b0</span>};
            <span style="color:#66d9ef">end</span>
        <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>done) <span style="color:#66d9ef">begin</span>
            <span style="color:#66d9ef">if</span> (i <span style="color:#f92672">==</span> WIDTH<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) <span style="color:#66d9ef">begin</span>  <span style="color:#75715e">// we&#39;re done
</span><span style="color:#75715e"></span>                done <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1</span>;
                q <span style="color:#f92672">&lt;=</span> q1_next;
                r <span style="color:#f92672">&lt;=</span> r1_next <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">1</span>;
            <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">begin</span>  <span style="color:#75715e">// next iteration
</span><span style="color:#75715e"></span>                i <span style="color:#f92672">&lt;=</span> i <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
                r1 <span style="color:#f92672">&lt;=</span> r1_next;
                q1 <span style="color:#f92672">&lt;=</span> q1_next;
            <span style="color:#66d9ef">end</span>
        <span style="color:#66d9ef">end</span>
    <span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">endmodule</span>
</code></pre></div><p>The Verilog itself is straightforward. The core part of the algorithm is in the <code>always_comb</code> block. The <code>always_ff</code> block tests for division by zero, sets up the initial values, then runs the core algorithm for the same number of cycles as the width of the numbers.</p>
<p><em>ProTip: I&rsquo;ve used SystemVerilog, but the only SV constructs are <code>$clog2</code> and the always blocks.</em></p>
<h3 id="testing">Testing</h3>
<p><em><strong>A simple test bench is incoming.</strong></em></p>
<h2 id="fixed-point-support">Fixed Point Support</h2>
<p>In a previous recipe we looked at <a href="/posts/fixed-point-numbers-in-verilog/">Fixed Point Numbers in Verilog</a>, but didn&rsquo;t cover division, so let&rsquo;s do that now. We have two changes to make:</p>
<ol>
<li>Scaling the quotient</li>
<li>Handling overflow</li>
</ol>
<p>If we use fixed-point numbers with the original module (above), the resulting quotient is not <strong>scaled</strong> correctly. For example, if we divide <code>8</code> by <code>4</code> in Q4.4 format the result is <code>0.25</code>, rather than the customary <code>2</code>. To get the correct result we shift the quotient left by the number of bits in the fractional part of the number, in this case 4 bits:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">   1000.0000        8.0000
/  0100.0000      / 4.0000
=  0000.0010      = 0.2500 (unscaled)
&lt;&lt; 0100           &lt;&lt; 4 (scale)
   0010.0000      = 2.0000
</code></pre></div><p>Because of the quotient scaling it&rsquo;s possible for overflow to occur. Consider dividing <code>8</code> by <code>0.25</code> using Q4.4 format. After scaling we end up with the result <code>0</code> rather than the expected <code>32</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">   1000.0000         8.0000
/  0000.0010      /  0.2500
=  0010.0000      =  4 (unscaled)
&lt;&lt; 0100           &lt;&lt; 4 (scale)
   0000.0000      =  0 ?!
</code></pre></div><p>We could ignore this and make the module user responsible for overflow, but it&rsquo;s much easier for the module to do this before the scaling occurs. To indicate overflow we set the overflow flag <code>ovf</code>.</p>
<p>With these changes the module looks like this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-verilog" data-lang="verilog"><span style="color:#75715e">// Project F: Division (with fixed-point support)
</span><span style="color:#75715e">// (C)2020 Will Green, Open source hardware released under the MIT License
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">module</span> div #(
    <span style="color:#66d9ef">parameter</span> WIDTH<span style="color:#f92672">=</span><span style="color:#ae81ff">32</span>, <span style="color:#75715e">// width of number in bits
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">parameter</span> FBITS<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>   <span style="color:#75715e">// fractional bits
</span><span style="color:#75715e"></span>    ) (
    <span style="color:#66d9ef">input</span> <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> clk,
    <span style="color:#66d9ef">input</span> <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> start,          <span style="color:#75715e">// start signal
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">input</span> <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> [WIDTH<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] x,  <span style="color:#75715e">// dividend
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">input</span> <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> [WIDTH<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] y,  <span style="color:#75715e">// divisor
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>     <span style="color:#66d9ef">logic</span> [WIDTH<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] q,  <span style="color:#75715e">// quotient
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>     <span style="color:#66d9ef">logic</span> [WIDTH<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] r,  <span style="color:#75715e">// remainder
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>     <span style="color:#66d9ef">logic</span> done,           <span style="color:#75715e">// done signal
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>     <span style="color:#66d9ef">logic</span> dbz,            <span style="color:#75715e">// divide by zero flag
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>     <span style="color:#66d9ef">logic</span> ovf             <span style="color:#75715e">// overflow flag (fixed-point)
</span><span style="color:#75715e"></span>    );

    <span style="color:#75715e">// avoid negative vector width when fractional bits are not used
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> FBITSW <span style="color:#f92672">=</span> (FBITS) <span style="color:#f92672">?</span> FBITS <span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span>;

    <span style="color:#66d9ef">logic</span> [WIDTH<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] y1;            <span style="color:#75715e">// copy of divisor
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [WIDTH<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] q1, q1_next;   <span style="color:#75715e">// intermediate quotient
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [WIDTH<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] r1, r1_next;   <span style="color:#75715e">// intermediate remainder
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [$clog2(WIDTH<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>)<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] i;   <span style="color:#75715e">// dividend bit counter
</span><span style="color:#75715e"></span>
    <span style="color:#66d9ef">always_comb</span> <span style="color:#66d9ef">begin</span>
        <span style="color:#66d9ef">if</span> (r1 <span style="color:#f92672">&gt;=</span> y1) <span style="color:#66d9ef">begin</span>
            r1_next <span style="color:#f92672">=</span> r1 <span style="color:#f92672">-</span> y1;
            {r1_next, q1_next} <span style="color:#f92672">=</span> {r1_next[WIDTH<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>], q1, <span style="color:#ae81ff">1</span><span style="color:#ae81ff">&#39;b1</span>};
        <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">begin</span>
            {r1_next, q1_next} <span style="color:#f92672">=</span> {r1, q1} <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">1</span>;
        <span style="color:#66d9ef">end</span>
    <span style="color:#66d9ef">end</span>

    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk) <span style="color:#66d9ef">begin</span>
        <span style="color:#66d9ef">if</span> (start) <span style="color:#66d9ef">begin</span>
            ovf <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
            q <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
            r <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
            i <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
            <span style="color:#66d9ef">if</span> (y <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) <span style="color:#66d9ef">begin</span>  <span style="color:#75715e">// catch divide by zero
</span><span style="color:#75715e"></span>                dbz <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1</span>;
                done <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1</span>;
            <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">begin</span>
                dbz <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
                done <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
                y1 <span style="color:#f92672">&lt;=</span> y;
                {r1, q1} <span style="color:#f92672">&lt;=</span> {{WIDTH<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>{<span style="color:#ae81ff">1</span><span style="color:#ae81ff">&#39;b0</span>}}, x, <span style="color:#ae81ff">1</span><span style="color:#ae81ff">&#39;b0</span>};
            <span style="color:#66d9ef">end</span>
        <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>done) <span style="color:#66d9ef">begin</span>
            <span style="color:#66d9ef">if</span> (i <span style="color:#f92672">==</span> WIDTH<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) <span style="color:#66d9ef">begin</span>  <span style="color:#75715e">// done
</span><span style="color:#75715e"></span>                done <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1</span>;
                <span style="color:#66d9ef">if</span> (FBITS <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> q1_next[WIDTH<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span>WIDTH<span style="color:#f92672">-</span>FBITSW]) <span style="color:#66d9ef">begin</span>  <span style="color:#75715e">// catch overflow
</span><span style="color:#75715e"></span>                    ovf <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1</span>;
                    q <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
                    r <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
                <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">begin</span>
                    q <span style="color:#f92672">&lt;=</span> q1_next <span style="color:#f92672">&lt;&lt;</span> FBITS;  <span style="color:#75715e">// fixed-point correction
</span><span style="color:#75715e"></span>                    r <span style="color:#f92672">&lt;=</span> r1_next <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">1</span>;
                <span style="color:#66d9ef">end</span>
            <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">begin</span>  <span style="color:#75715e">// next iteration
</span><span style="color:#75715e"></span>                i <span style="color:#f92672">&lt;=</span> i <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
                r1 <span style="color:#f92672">&lt;=</span> r1_next;
                q1 <span style="color:#f92672">&lt;=</span> q1_next;
            <span style="color:#66d9ef">end</span>
        <span style="color:#66d9ef">end</span>
    <span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">endmodule</span>
</code></pre></div>
      
      <div class="related">

<h3>Similar articles:</h3>
<ul>
	
	<li><a href="/posts/video-timings-vga-720p-1080p/">Video Timings: VGA, SVGA, 720p, 1080p</a></li>
	
	<li><a href="/posts/fixed-point-numbers-in-verilog/">Fixed Point Numbers in Verilog</a></li>
	
	<li><a href="/posts/initialize-memory-in-verilog/">Initialize Memory in Verilog</a></li>
	
</ul>
</div>
      
    </div>
    
  </div>
</section>

    <script src="/js/copycode.js"></script>



<section class="section">
  <div class="container has-text-centered">
    <p>©2020 Will Green, Project F</p>
    
  </div>
</section>


<script src="https://narwhal.projectf.io/script.js" site="EVCGKVDN" defer></script>
</body>
</html>

